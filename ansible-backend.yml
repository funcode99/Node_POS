---
    - name: "Image Builder"
      hosts: localhost
      become: true
      vars:
        hub: "silverstack19"
        proj: "ansible-backend"
        dests: backend
        repo: https://github.com/funcode99/Node_POS.git

      tasks:
        - name: "Check Connections"
          ping:

        - name: "Ensure git instaled"
          yum:
            name: git
            state: present

        - name: "Installing python docker"
          pip:
            name: docker-py
            executable: pip2

        - name: "Clone repository"
          git:
            repo: "{{repo}}"
            dest: "{{dests}}"
            version: dev

        - name: "Build image docker"
          community.general.docker_image:
            name: "{{hub}}/{{proj}}"
            build:
              path: "{{dests}}"
            source: build

        - name: "push docker image"
          community.general.docker_image:
            name: "{{hub}}/{{proj}}"
            repository: "{{hub}}/{{proj}}:dev"
            push: yes
            source: local

    - name: "Image Run"
      hosts: production
      tasks:
        - name: make directory for backend
          file:
            path: backend
            state: directory
        - name: "Ensure docker-compose instaled"
          become: true
          apt:
            name: docker-compose
            state: present
        - name: "send docker compose to deployment node"
          copy: src=backend/docker-compose.yml dest=backend/docker-compose.yml
        - name: "Running container on server deployment"
          command: bash -lc "cd /home/ansman/backend && docker-compose up -d"
